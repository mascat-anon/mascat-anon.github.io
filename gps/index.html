<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <style>
    .speed {
      font-size: 2em;
      transition: all 0.5s ease-in-out;
    }
  </style>
  <script>
    $(function () {
      if (!navigator.geolocation) {
        alert("このブラウザでは位置情報がサポートされていません。");
        return;
      }

      const speeds = []; // 速度履歴（最大3個）
      let currentDisplaySpeed = 0; // 表示用速度

      function calcAverageSpeed() {
        if (speeds.length === 0) return 0;
        const sum = speeds.reduce((a, b) => a + b, 0);
        return sum / speeds.length;
      }

      function classifyMotion(avgSpeed, prevAvg) {
        if (Math.abs(avgSpeed - prevAvg) > 5) {
          return avgSpeed > prevAvg ? "加速中" : "減速中";
        } else if (speeds.length === 3 && Math.max(...speeds) - Math.min(...speeds) > 10) {
          return "蛇行中";
        } else {
          return "安定走行";
        }
      }

      function updateDisplay(speed) {
        const smoothSpeed = currentDisplaySpeed + (speed - currentDisplaySpeed) * 0.3;
        currentDisplaySpeed = smoothSpeed;
        $('.speed').text("速度: " + Math.floor(smoothSpeed) + " km/h");
      }

      let prevAvgSpeed = 0;

      function getPosition() {
        navigator.geolocation.getCurrentPosition(function (position) {
          const speedMps = position.coords.speed || 0;
          const speedKmh = speedMps * 3.6;

          // 速度履歴に追加（最大3件）
          speeds.push(speedKmh);
          if (speeds.length > 3) speeds.shift();

          const avgSpeed = calcAverageSpeed();
          const motion = classifyMotion(avgSpeed, prevAvgSpeed);
          prevAvgSpeed = avgSpeed;

          // 日時なども更新
          const date = new Date();
          const time = date.toLocaleString();
          $('#watch-position .time').text("取得: " + time);
          $('#watch-position .lat').text("緯度: " + position.coords.latitude);
          $('#watch-position .lon').text("経度: " + position.coords.longitude);
          $('#watch-position .alt').text("高度[m]: " + position.coords.altitude);
          $('#watch-position .acc').text("精度[m]: " + position.coords.accuracy);
          $('#watch-position .alt-acc').text("高度の正確性[m]: " + position.coords.altitudeAccuracy);
          $('#watch-position .heading').text("方位[deg]: " + position.coords.heading);
          $('#watch-position .status').text("状態: " + motion);

          updateDisplay(avgSpeed);
        }, function (error) {
          let msg = "不明なエラー";
          if (error.code === 1) msg = "位置情報が許可されていません";
          if (error.code === 2) msg = "現在地を特定できません";
          if (error.code === 3) msg = "位置情報取得がタイムアウトしました";
          $('#watch-position .status').text("エラー: " + msg);
        }, {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000
        });
      }

      // 0.5秒ごとに速度取得
      setInterval(getPosition, 500);
    });
  </script>
</head>
<body>
  <div id="watch-position">
    <p class="status">処理中・・・</p>
    <p class="time">Timestamp: </p>
    <p class="lat">緯度： wait...</p>
    <p class="lon">経度： wait...</p>
    <p class="alt">高度：</p>
    <p class="acc">正確性：</p>
    <p class="alt-acc">高度の正確性：</p>
    <p class="heading">方位：</p>
    <p class="speed">速度：</p>
  </div>
</body>
</html>
