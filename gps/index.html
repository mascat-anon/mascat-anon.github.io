<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <style>
    .speed {
      font-size: 2em;
      transition: all 0.3s ease;
    }
    .motion {
      font-size: 1.5em;
      font-weight: bold;
      color: #0066cc;
    }
  </style>
</head>
<body>
  <div id="watch-position">
    <p class="status">処理中・・・</p>
    <p class="time">Timestamp: </p>
    <p class="lat">緯度： wait...</p>
    <p class="lon">経度： wait...</p>
    <p class="speed">速度：0 km/h</p>
    <p class="motion">状態分類：待機中</p>
  </div>

  <script>
    $(function () {
      if (!navigator.geolocation) {
        alert("このブラウザでは位置情報がサポートされていません。");
        return;
      }

      let speeds = [];
      let prevAvgSpeed = 0;
      let smoothLat = null;
      let smoothLon = null;
      let prevTime = null;
      let currentDisplaySpeed = 0;

      function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const toRad = deg => deg * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function classifyMotion(avg, prevAvg) {
        if (Math.abs(avg - prevAvg) > 5) {
          return avg > prevAvg ? "加速中" : "減速中";
        } else if (speeds.length === 3 && Math.max(...speeds) - Math.min(...speeds) > 10) {
          return "蛇行中";
        } else {
          return "安定走行";
        }
      }

      function updateDisplay(speed, lat, lon) {
        // 補間：滑らかに変化させる
        currentDisplaySpeed += (speed - currentDisplaySpeed) * 0.3;

        // 小数点以下切り捨て & 1km単位表示（常に整数）
        const shownSpeed = Math.floor(currentDisplaySpeed);

        $('.speed').text("速度: " + shownSpeed + " km/h");
        $('.lat').text("緯度: " + lat.toFixed(6));
        $('.lon').text("経度: " + lon.toFixed(6));
      }

      function processPosition(position) {
        const now = Date.now();
        const rawLat = position.coords.latitude;
        const rawLon = position.coords.longitude;

        if (smoothLat === null || smoothLon === null) {
          smoothLat = rawLat;
          smoothLon = rawLon;
          prevTime = now;
          return;
        }

        const alpha = 0.3;
        smoothLat += (rawLat - smoothLat) * alpha;
        smoothLon += (rawLon - smoothLon) * alpha;

        const dt = (now - prevTime) / 1000;
        const dist = haversine(smoothLat, smoothLon, rawLat, rawLon);
        const speed = (dist / dt) * 3.6;

        speeds.push(speed);
        if (speeds.length > 3) speeds.shift();

        const avgSpeed = speeds.reduce((a, b) => a + b, 0) / speeds.length;
        const motion = classifyMotion(avgSpeed, prevAvgSpeed);
        prevAvgSpeed = avgSpeed;

        $('.time').text("取得: " + new Date().toLocaleString());
        $('.status').text("状態: 正常");
        $('.motion').text("状態分類: " + motion);

        updateDisplay(avgSpeed, smoothLat, smoothLon);
        prevTime = now;
      }

      function getPosition() {
        navigator.geolocation.getCurrentPosition(
          processPosition,
          function (error) {
            let msg = "不明なエラー";
            if (error.code === 1) msg = "位置情報が許可されていません";
            if (error.code === 2) msg = "現在地を特定できません";
            if (error.code === 3) msg = "位置情報取得がタイムアウトしました";

            $('.status').text("エラー: " + msg);
            $('.motion').text("状態分類: 取得失敗");
            $('.speed').text("速度: 0 km/h");
          },
          {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 10000
          }
        );
      }

      // 定期取得（0.5秒）
      setInterval(getPosition, 500);
    });
  </script>
</body>
</html>
